#      传输层协议：TCP协议（上）——协议结构、主要特点以及应用场景

## 简介

**传输控制协议**（英语：**T**ransmission **C**ontrol **P**rotocol，缩写：**TCP**）是一种面向连接的、可靠的、基于[字节流](https://zh.wikipedia.org/wiki/字節流)的[传输层](https://zh.wikipedia.org/wiki/传输层)通信协议，由[IETF](https://zh.wikipedia.org/wiki/IETF)的[RFC](https://zh.wikipedia.org/wiki/RFC) [793](https://tools.ietf.org/html/rfc793)定义。在简化的计算机网络[OSI模型](https://zh.wikipedia.org/wiki/OSI模型)中，它完成第四层传输层所指定的功能。

应用层向TCP层发送用于网间传输的、用8位字节表示的数据流，然后TCP把数据流分割成适当长度的报文段（通常受该计算机连接的网络的数据链路层的[最大传输单元](https://zh.wikipedia.org/wiki/最大传输单元)（MTU）的限制）。之后TCP把结果包传给IP层，由它来透过网络将包传送给接收端实体的TCP层。TCP为了保证不发生丢包，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接收。然后接收端实体对已成功收到的包发回一个相应的[确认信息](https://zh.wikipedia.org/wiki/確認訊息)（ACK）；如果发送端实体在合理的[往返时延](https://zh.wikipedia.org/wiki/來回通訊延遲)（RTT）内未收到确认，那么对应的数据包就被假设为[已丢失](https://zh.wikipedia.org/wiki/丢包)并进行重传。TCP用一个[校验和](https://zh.wikipedia.org/wiki/校验和)函数来检验数据是否有错误，在发送和接收时都要计算校验和。



## 数据包结构

![数据包结构](https://s2.loli.net/2023/01/08/fMENdUuWvHXqksY.png)

- 来源连接端口（16位长）－识别发送连接端口
- 目的连接端口（16位长）－识别接收连接端口
- 序列号（seq，32位长）
  - 如果含有同步化旗标（SYN），则此为最初的序列号；第一个资料比特的序列码为本序列号加一。
  - 如果没有同步化旗标（SYN），则此为第一个资料比特的序列码。
- 确认号（ack，32位长）—期望收到的数据的开始序列号。也即已经收到的数据的字节长度加1。
- 资料偏移（4位长）—以4字节为单位计算出的数据段开始地址的偏移值。
- 保留（3比特长）—须置0
- 标志符（9比特长）
  - NS—ECN-nonce。ECN显式拥塞通知（Explicit Congestion Notification）是对TCP的扩展，定义于 RFC 3540 （2003）。ECN允许拥塞控制的端对端通知而避免丢包。ECN为一项可选功能，如果底层网络设施支持，则可能被启用ECN的两个端点使用。在ECN成功协商的情况下，ECN感知路由器可以在IP头中设置一个标记来代替丢弃数据包，以标明阻塞即将发生。数据包的接收端回应发送端的表示，降低其传输速率，就如同在往常中检测到包丢失那样。
  - CWR—Congestion Window Reduced，定义于 RFC 3168（2001）。
  - ECE—ECN-Echo有两种意思，取决于SYN标志的值，定义于 RFC 3168（2001）。
  - URG—为1表示高优先级数据包，紧急指针字段有效。
  - ACK—为1表示确认号字段有效
  - PSH—为1表示是带有PUSH标志的数据，指示接收方应该尽快将这个报文段交给应用层而不用等待缓冲区装满。
  - RST—为1表示出现严重差错。可能需要重新创建TCP连接。还可以用于拒绝非法的报文段和拒绝连接请求。
  - SYN—为1表示这是连接请求或是连接接受请求，用于创建连接和使顺序号同步
  - FIN—为1表示发送方没有数据要传输了，要求释放连接。
- 窗口（WIN，16位长）—表示从确认号开始，本报文的发送方可以接收的字节数，即接收窗口大小。用于流量控制。
- 校验和（Checksum，16位长）—对整个的TCP报文段，包括TCP头部和TCP数据，以16位字进行计算所得。这是一个强制性的字段。
- 紧急指针（16位长）—本报文段中的紧急数据的最后一个字节的序号。
- 选项字段—最多40字节。每个选项的开始是1字节的kind字段，说明选项的类型。
  - 0：选项表结束（1字节）
  - 1：无操作（1字节）用于选项字段之间的字边界对齐。
  - 2：最大报文段长度（4字节，Maximum Segment Size，MSS）通常在创建连接而设置SYN标志的数据包中指明这个选项，指明本端所能接收的最大长度的报文段。通常将MSS设置为（MTU-40）字节，携带TCP报文段的IP数据报的长度就不会超过MTU（MTU最大长度为1518字节，最短为64字节），从而避免本机发生IP分片。只能出现在同步报文段中，否则将被忽略。
  - 3：窗口扩大因子（3字节，wscale），取值0-14。用来把TCP的窗口的值左移的位数，使窗口值乘倍。只能出现在同步报文段中，否则将被忽略。这是因为现在的TCP接收数据缓冲区（接收窗口）的长度通常大于65535字节。
  - 4：sackOK—发送端支持并同意使用SACK选项。
  - 5：SACK实际工作的选项。
  - 8：时间戳（10字节，TCP Timestamps Option，TSopt）
    - 发送端的时间戳（Timestamp Value field，TSval，4字节）
    - 时间戳回显应答（Timestamp Echo Reply field，TSecr，4字节）
  - 19：MD5摘要，将TCP伪首部、校验和为0的TCP首部、TCP数据段、通信双方约定的密钥（可选）计算出[MD5](https://zh.wikipedia.org/wiki/MD5)摘要值并附加到该选项中，作为类似对TCP报文的签名。通过 [RFC 2385](https://tools.ietf.org/html/rfc2385) 引入，主要用于增强[BGP](https://zh.wikipedia.org/wiki/边界网关协议)通信的安全性。
  - 29：安全摘要，通过 [RFC 5925](https://tools.ietf.org/html/rfc5925) 引入，将“MD5摘要”的散列方法更换为[SHA散列算法](https://zh.wikipedia.org/wiki/SHA家族)。

## 主要特点

- **面向连接**，也就是说，应用程序在使用TCP协议之前，必须先建立TCP连接。数据传输完毕以后，必须释放已经建立的TCP的连接。
- 提供**可靠交付**的服务。通过TCP连接传输的数据，不丢失、不重复、无差错，并且按需到达。
- **面向字节流。**TCP中“**流(Stream)”指的是流入到进程或从进程流出的字节序列**。 
- **点对点（一对一）**
- **TCP首部开销20字节;UDP的首部开销更小，只有8个字节**
- **TCP是可以拥塞控制**。它意识到包丢弃了或者网络的环境不好了，就会根据情况调整自己的行为，看看是不是发快了，要不要发慢点。



## 应用场景

**TCP适合对传输效率要求不高，但准确率要求高的应用场景**，比如万维网(HTTP)、文件传输(FTP)、电子邮件(SMTP)等。

除外，由于TCP的实现是由操作系统提供，而TCP的悠久历史、系统级别的配置机制，一些特性在特定的网络环境下会成为一种累赘而且无法优化，所以也有一些通过在UDP上重新实现用户层级的类似TCP的面向连接的、可靠的、基于字节流的类传输层协议，来代替TCP，例如[QUIC](https://zh.wikipedia.org/wiki/QUIC)。



## 参考链接

1.维基百科：https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE